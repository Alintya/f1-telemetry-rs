use serial_test::serial;

use f1_telemetry::packet::event::{Event, InfringementType, PacketEventData, Penalty, PenaltyType};
use f1_telemetry::packet::generic::{Flag, WheelData};
use f1_telemetry::packet::motion::{CarMotionData, PacketMotionData};
use f1_telemetry::packet::session::{
    BrakingAssist, DrivingAssists, DynamicRacingLine, DynamicRacingLineType, ForecastAccuracy,
    Formula, GearboxAssist, MarshalZone, PacketSessionData, SafetyCar, SessionType,
    TemperatureChange, Track, Weather, WeatherForecastSample,
};
use f1_telemetry::packet::Packet;

mod utils;

#[test]
#[serial]
fn test_parse_2021_motion_packet() {
    let stream = utils::get_stream();

    utils::send_raw_data(&stream, "e507011201002e324e2ac5eb38ad0f6498422006000013ffb48f9d433741af4246ba5b44ea58674130536cbbac2c6e42431ef9ff5d7ca383f7ff431e10791b3df5363a3f831e583bbb6c743e008079b9b19a9c390318a043723faf42fb825f4451317f41281f5bbb285e8242681ef7ff547cac830100681ef0051f3c60744f3f5063b93b479d753e0040e338a9e437b8ec3a9e430d40af425eda5c44116377414c4a95bb97d27d424b1efbff5b7ca58300004b1e34df3b3cd6b45f3f44c14bbb0cb4743e0080573898f92cb7913ea143f73eaf42897b614412838241381484bb010785427f1ef4ff4f7cb18302007f1e30201e3c4846433f5b71423ac259763e00401d391a2886b8c218a243a73eaf42b83b64442ce1834108f287bb13d58642651ef3ff557cab830000651e0c24693c683c3b3feb12f9b9318a753e0040f038b8736eb738cf9b431441af42851357442aaf6c41884965bb80057142831e00004e7cb2830400831e8fa164bd68b2773f07ff3a3beb7c763e00a00d39eea20db9b709a043633faf42c9025f44b82b8041605176bb30b88242711ef7ff527cae830500711efae1fbbbdda34d3ff746d1bae6ec753e0080703970802cb968879d432d40af42b7875a4417437741a04e99bb75537c42731efcff527cae830200731ebd4f15bdce0f633f597859bb54fd753e00c0cd38781a86b801af9f436f3faf4284755f4465e87e4158288ebb087182425c1ef7ff577ca98300005c1e7765393d290a4f3fff7c423af93b753e0000a03820c924b733b3a0433040af42e984624443297441144696bbe9ec7b42261efaff647c9c83ffff261e19e0b1bcb9c5553f3f642bbadc80733e0000f43614fd23386ff59b43e840af4269cd5744e34e6c41f65410bc43117242571ee8ff597ca7830400571e25678fbc2d9ce5bec10218bdab10753e00a0a1398dd30cb986639e43d93faf42e4ca5d4450eb764154858abbd31d8042141efaff697c9783eaff141e5591c43dcf725a3f77d47fbb42ea723e00d822ba557e343a2f12a043213faf42e5c860443a9d80417cd597bb0b4f8442381ef5ff607ca083ffff381e0fb58fbbccd1463f9983c4bb0214743e00803a38cd521a38ae029f43b33faf421d605e44dc537b41f8cb64bb61fc8042481ef9ff5c7ca4830100481e2ae112bd7cd3553f7ac5293b9c94743e0000ed38f41577b8e43c9f43bd3faf4296f85d4456b47b4190927cbb0f9a8042671ef9ff557cab830100671e43bfde3c707d573f20a1783bd596753e0000d8384bb75bb8ffc89b43fe40af425b38574448ac6d41ccd484bbed3272427d1effff4f7cb18301007d1e28393cbd24e8723f2aba35bb914d763e00003e380ee51db84d719e43e03faf42df9a5d4497d77841d82170bbb0058042361efaff607ca0830000361ea175bd3cee7e5a3f907607bbee05743e00009c38a0dbe7b787aa97439a42af42cd4f4f44def0524130151c3c6c2f5c42ce1d01007a7c86830200ce1d70b6263cf041823ffa8318bc0bab703e00808b38c261acb8f3c09c438240af42f4195a4490856e418c701abc9b5b7842d21dffff797c8783d2ffd21d0be3773ed3a86c3fd2fa503c65cb703e008cb2babb29b93a0300ba43733eaf428c718d4437a88c41f84e3cbb7c51a1426f1b1b00057dfb82d8ff6f1b2dfb393e3803923eaacec63b7d375d3e0060b7baf5bda33a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012f75e40779fa040875c3e419b8b52418f45d6406a4a17c00775b940ecfdbbbfbfdfa541a65c544375e514c228d66e43afc4a54289cfa542d42ba5421b37a5423722873b9193893bb0dc033a2266113ae24eeebdcd8492bd2d1ba5427f932bbbab402e3c22013abc79870fbea51288befb571cbf00000080");

    let p = utils::get_packet(&stream).unwrap().unwrap();

    let actual = match p {
        Packet::Motion(m) => m,
        _ => panic!("Invalid packet. Expected Motion, got {:?}", &p),
    };

    assert_eq!(actual.header.packet_format, 2021);

    let expected = PacketMotionData {
        header: actual.header.clone(),
        motion_data: vec![
            CarMotionData {
                world_position_x: 315.12268,
                world_position_y: 87.62737,
                world_position_z: 878.9105,
                world_velocity_x: 14.459208,
                world_velocity_y: -0.0036060326,
                world_velocity_z: 59.543625,
                world_forward_dir_x: 7747,
                world_forward_dir_y: -7,
                world_forward_dir_z: 31837,
                world_right_dir_x: -31837,
                world_right_dir_y: -9,
                world_right_dir_z: 7747,
                g_force_lateral: 0.03795725,
                g_force_longitudinal: 0.7274011,
                g_force_vertical: 0.003297717,
                yaw: 0.23869602,
                pitch: -0.00023794174,
                roll: 0.00029869893,
            },
            CarMotionData {
                world_position_x: 320.1876,
                world_position_y: 87.62392,
                world_position_z: 894.0466,
                world_velocity_x: 15.94954,
                world_velocity_y: -0.0033435319,
                world_velocity_z: 65.1839,
                world_forward_dir_x: 7784,
                world_forward_dir_y: -9,
                world_forward_dir_z: 31828,
                world_right_dir_x: -31828,
                world_right_dir_y: 1,
                world_right_dir_z: 7784,
                g_force_lateral: 0.009706005,
                g_force_longitudinal: 0.8103695,
                g_force_vertical: 0.005657591,
                yaw: 0.23985778,
                pitch: 0.000108361244,
                roll: -4.3843556e-5,
            },
            CarMotionData {
                world_position_x: 316.46033,
                world_position_y: 87.6251,
                world_position_z: 883.412,
                world_velocity_x: 15.461686,
                world_velocity_y: -0.004555976,
                world_velocity_z: 63.455654,
                world_forward_dir_x: 7755,
                world_forward_dir_y: -5,
                world_forward_dir_z: 31835,
                world_right_dir_x: -31835,
                world_right_dir_y: 0,
                world_right_dir_z: 7755,
                g_force_lateral: 0.01146679,
                g_force_longitudinal: 0.8738531,
                g_force_vertical: -0.0031090537,
                yaw: 0.23896807,
                pitch: 5.1379204e-5,
                roll: -1.0310112e-5,
            },
            CarMotionData {
                world_position_x: 322.4888,
                world_position_y: 87.62298,
                world_position_z: 901.93024,
                world_velocity_x: 16.314,
                world_velocity_y: -0.0040307306,
                world_velocity_z: 66.51368,
                world_forward_dir_x: 7807,
                world_forward_dir_y: -12,
                world_forward_dir_z: 31823,
                world_right_dir_x: -31823,
                world_right_dir_y: 2,
                world_right_dir_z: 7807,
                g_force_lateral: 0.009651229,
                g_force_longitudinal: 0.76279116,
                g_force_vertical: 0.0007417404,
                yaw: 0.24057677,
                pitch: 0.00014996529,
                roll: -6.3970874e-5,
            },
            CarMotionData {
                world_position_x: 324.19342,
                world_position_y: 87.62237,
                world_position_z: 912.9331,
                world_velocity_x: 16.484947,
                world_velocity_y: -0.0041487254,
                world_velocity_z: 67.41616,
                world_forward_dir_x: 7781,
                world_forward_dir_y: -13,
                world_forward_dir_z: 31829,
                world_right_dir_x: -31829,
                world_right_dir_y: 0,
                world_right_dir_z: 7781,
                g_force_lateral: 0.014229786,
                g_force_longitudinal: 0.7313905,
                g_force_vertical: -0.00047507076,
                yaw: 0.23978497,
                pitch: 0.00011456013,
                roll: -1.4212848e-5,
            },
            CarMotionData {
                world_position_x: 311.6189,
                world_position_y: 87.627106,
                world_position_z: 860.305,
                world_velocity_x: 14.792765,
                world_velocity_y: -0.0034986455,
                world_velocity_z: 60.25537,
                world_forward_dir_x: 7811,
                world_forward_dir_y: 0,
                world_forward_dir_z: 31822,
                world_right_dir_x: -31822,
                world_right_dir_y: 4,
                world_right_dir_z: 7811,
                g_force_lateral: -0.055818137,
                g_force_longitudinal: 0.967566,
                g_force_vertical: 0.0028533356,
                yaw: 0.2407109,
                pitch: 0.00013506413,
                roll: -0.00013507504,
            },
            CarMotionData {
                world_position_x: 320.0759,
                world_position_y: 87.6238,
                world_position_z: 892.0435,
                world_velocity_x: 16.021347,
                world_velocity_y: -0.0037585124,
                world_velocity_z: 65.35974,
                world_forward_dir_x: 7793,
                world_forward_dir_y: -9,
                world_forward_dir_z: 31826,
                world_right_dir_x: -31826,
                world_right_dir_y: 5,
                world_right_dir_z: 7793,
                g_force_lateral: -0.0076868506,
                g_force_longitudinal: 0.8032816,
                g_force_vertical: -0.0015966584,
                yaw: 0.24016151,
                pitch: 0.00022935867,
                roll: -0.00016451045,
            },
            CarMotionData {
                world_position_x: 315.05786,
                world_position_y: 87.62534,
                world_position_z: 874.12054,
                world_velocity_x: 15.453879,
                world_velocity_y: -0.0046785623,
                world_velocity_z: 63.0815,
                world_forward_dir_x: 7795,
                world_forward_dir_y: -4,
                world_forward_dir_z: 31826,
                world_right_dir_x: -31826,
                world_right_dir_y: 2,
                world_right_dir_z: 7795,
                g_force_lateral: -0.036452997,
                g_force_longitudinal: 0.8869599,
                g_force_vertical: -0.0033183305,
                yaw: 0.24022418,
                pitch: 9.8109245e-5,
                roll: -6.394548e-5,
            },
            CarMotionData {
                world_position_x: 319.36722,
                world_position_y: 87.62389,
                world_position_z: 893.8362,
                world_velocity_x: 15.931737,
                world_velocity_y: -0.0043383054,
                world_velocity_z: 65.220764,
                world_forward_dir_x: 7772,
                world_forward_dir_y: -9,
                world_forward_dir_z: 31831,
                world_right_dir_x: -31831,
                world_right_dir_y: 0,
                world_right_dir_z: 7772,
                g_force_lateral: 0.04526278,
                g_force_longitudinal: 0.8087488,
                g_force_vertical: 0.00074191386,
                yaw: 0.23948659,
                pitch: 7.6293945e-5,
                roll: -9.82199e-6,
            },
            CarMotionData {
                world_position_x: 321.4,
                world_position_y: 87.62537,
                world_position_z: 906.0767,
                world_velocity_x: 15.260074,
                world_velocity_y: -0.0045859907,
                world_velocity_z: 62.981358,
                world_forward_dir_x: 7718,
                world_forward_dir_y: -6,
                world_forward_dir_z: 31844,
                world_right_dir_x: -31844,
                world_right_dir_y: -1,
                world_right_dir_z: 7718,
                g_force_lateral: -0.021713303,
                g_force_longitudinal: 0.83504826,
                g_force_vertical: -0.000653807,
                yaw: 0.23779625,
                pitch: 7.2717667e-6,
                roll: 3.9097926e-5,
            },
            CarMotionData {
                world_position_x: 311.91745,
                world_position_y: 87.62677,
                world_position_z: 863.20953,
                world_velocity_x: 14.769259,
                world_velocity_y: -0.008809319,
                world_velocity_z: 60.516857,
                world_forward_dir_x: 7767,
                world_forward_dir_y: -24,
                world_forward_dir_z: 31833,
                world_right_dir_x: -31833,
                world_right_dir_y: 4,
                world_right_dir_z: 7767,
                g_force_lateral: -0.017505238,
                g_force_longitudinal: -0.44845715,
                g_force_vertical: -0.037112,
                yaw: 0.2393214,
                pitch: 0.00030827522,
                roll: -0.00013430249,
            },
            CarMotionData {
                world_position_x: 316.77753,
                world_position_y: 87.6247,
                world_position_z: 887.17017,
                world_velocity_x: 15.432449,
                world_velocity_y: -0.0042273197,
                world_velocity_z: 64.05825,
                world_forward_dir_x: 7700,
                world_forward_dir_y: -6,
                world_forward_dir_z: 31849,
                world_right_dir_x: -31849,
                world_right_dir_y: -22,
                world_right_dir_z: 7700,
                g_force_lateral: 0.095980324,
                g_force_longitudinal: 0.85331434,
                g_force_vertical: -0.003903655,
                yaw: 0.23722175,
                pitch: -0.0006211996,
                roll: 0.000688528,
            },
            CarMotionData {
                world_position_x: 320.14206,
                world_position_y: 87.6233,
                world_position_z: 899.139,
                world_velocity_x: 16.07677,
                world_velocity_y: -0.0046336036,
                world_velocity_z: 66.15438,
                world_forward_dir_x: 7736,
                world_forward_dir_y: -11,
                world_forward_dir_z: 31840,
                world_right_dir_x: -31840,
                world_right_dir_y: -1,
                world_right_dir_z: 7736,
                g_force_lateral: -0.0043855975,
                g_force_longitudinal: 0.77663875,
                g_force_vertical: -0.005997133,
                yaw: 0.23835757,
                pitch: 4.4465065e-5,
                roll: 3.6793575e-5,
            },
            CarMotionData {
                world_position_x: 318.02094,
                world_position_y: 87.62441,
                world_position_z: 889.5018,
                world_velocity_x: 15.7079735,
                world_velocity_y: -0.0034911614,
                world_velocity_z: 64.49293,
                world_forward_dir_x: 7752,
                world_forward_dir_y: -7,
                world_forward_dir_z: 31836,
                world_right_dir_x: -31836,
                world_right_dir_y: 1,
                world_right_dir_z: 7752,
                g_force_lateral: -0.035859264,
                g_force_longitudinal: 0.83525825,
                g_force_vertical: 0.0025905059,
                yaw: 0.23884815,
                pitch: 0.00011301041,
                roll: -5.8909834e-5,
            },
            CarMotionData {
                world_position_x: 318.4757,
                world_position_y: 87.62449,
                world_position_z: 887.88416,
                world_velocity_x: 15.731527,
                world_velocity_y: -0.0038539506,
                world_velocity_z: 64.300896,
                world_forward_dir_x: 7783,
                world_forward_dir_y: -7,
                world_forward_dir_z: 31829,
                world_right_dir_x: -31829,
                world_right_dir_y: 1,
                world_right_dir_z: 7783,
                g_force_lateral: 0.02719081,
                g_force_longitudinal: 0.8417578,
                g_force_vertical: 0.0037937835,
                yaw: 0.23983319,
                pitch: 0.000102996826,
                roll: -5.2384374e-5,
            },
            CarMotionData {
                world_position_x: 311.57028,
                world_position_y: 87.62694,
                world_position_z: 860.88055,
                world_velocity_x: 14.854561,
                world_velocity_y: -0.0040536877,
                world_velocity_z: 60.549732,
                world_forward_dir_x: 7805,
                world_forward_dir_y: -1,
                world_forward_dir_z: 31823,
                world_right_dir_x: -31823,
                world_right_dir_y: 1,
                world_right_dir_z: 7805,
                g_force_lateral: -0.045952946,
                g_force_longitudinal: 0.9488547,
                g_force_vertical: -0.002772937,
                yaw: 0.24053027,
                pitch: 4.529953e-5,
                roll: -3.764504e-5,
            },
            CarMotionData {
                world_position_x: 316.88516,
                world_position_y: 87.624756,
                world_position_z: 886.41986,
                world_velocity_x: 15.552634,
                world_velocity_y: -0.0036641266,
                world_velocity_z: 64.01111,
                world_forward_dir_x: 7734,
                world_forward_dir_y: -6,
                world_forward_dir_z: 31840,
                world_right_dir_x: -31840,
                world_right_dir_y: 0,
                world_right_dir_z: 7734,
                g_force_lateral: 0.023127379,
                g_force_longitudinal: 0.8534993,
                g_force_vertical: -0.0020670034,
                yaw: 0.23830387,
                pitch: 7.43866e-5,
                roll: -2.7639617e-5,
            },
            CarMotionData {
                world_position_x: 303.33224,
                world_position_y: 87.63008,
                world_position_z: 829.2469,
                world_velocity_x: 13.183805,
                world_velocity_y: 0.009526536,
                world_velocity_z: 55.04631,
                world_forward_dir_x: 7630,
                world_forward_dir_y: 1,
                world_forward_dir_z: 31866,
                world_right_dir_x: -31866,
                world_right_dir_y: 2,
                world_right_dir_z: 7630,
                g_force_lateral: 0.010175332,
                g_force_longitudinal: 1.0176373,
                g_force_vertical: -0.009308809,
                yaw: 0.23502748,
                pitch: 6.651878e-5,
                roll: -8.219808e-5,
            },
            CarMotionData {
                world_position_x: 313.50742,
                world_position_y: 87.62599,
                world_position_z: 872.4055,
                world_velocity_x: 14.907608,
                world_velocity_y: -0.009426247,
                world_velocity_z: 62.08946,
                world_forward_dir_x: 7634,
                world_forward_dir_y: -1,
                world_forward_dir_z: 31865,
                world_right_dir_x: -31865,
                world_right_dir_y: -46,
                world_right_dir_z: 7634,
                g_force_lateral: 0.24207704,
                g_force_longitudinal: 0.92445105,
                g_force_vertical: 0.012755113,
                yaw: 0.23515089,
                pitch: -0.0013622046,
                roll: 0.0014126817,
            },
            CarMotionData {
                world_position_x: 372.0001,
                world_position_y: 87.62197,
                world_position_z: 1131.5483,
                world_velocity_x: 17.582136,
                world_velocity_y: -0.0028733592,
                world_velocity_z: 80.65915,
                world_forward_dir_x: 7023,
                world_forward_dir_y: 27,
                world_forward_dir_z: 32005,
                world_right_dir_x: -32005,
                world_right_dir_y: -40,
                world_right_dir_z: 7023,
                g_force_lateral: 0.18162222,
                g_force_longitudinal: 0.2851808,
                g_force_vertical: 0.0060671167,
                yaw: 0.21603198,
                pitch: -0.0013990402,
                roll: 0.0012492525,
            },
            CarMotionData {
                world_position_x: 0.0,
                world_position_y: 0.0,
                world_position_z: 0.0,
                world_velocity_x: 0.0,
                world_velocity_y: 0.0,
                world_velocity_z: 0.0,
                world_forward_dir_x: 0,
                world_forward_dir_y: 0,
                world_forward_dir_z: 0,
                world_right_dir_x: 0,
                world_right_dir_y: 0,
                world_right_dir_z: 0,
                g_force_lateral: 0.0,
                g_force_longitudinal: 0.0,
                g_force_vertical: 0.0,
                yaw: 0.0,
                pitch: 0.0,
                roll: 0.0,
            },
            CarMotionData {
                world_position_x: 0.0,
                world_position_y: 0.0,
                world_position_z: 0.0,
                world_velocity_x: 0.0,
                world_velocity_y: 0.0,
                world_velocity_z: 0.0,
                world_forward_dir_x: 0,
                world_forward_dir_y: 0,
                world_forward_dir_z: 0,
                world_right_dir_x: 0,
                world_right_dir_y: 0,
                world_right_dir_z: 0,
                g_force_lateral: 0.0,
                g_force_longitudinal: 0.0,
                g_force_vertical: 0.0,
                yaw: 0.0,
                pitch: 0.0,
                roll: 0.0,
            },
        ],
        suspension_position: WheelData {
            rear_left: 3.48383,
            rear_right: 5.019466,
            front_left: 11.89759,
            front_right: 13.159083,
        },
        suspension_velocity: WheelData {
            rear_left: 6.695991,
            rear_right: -2.3639169,
            front_left: 5.7955356,
            front_right: -1.4686866,
        },
        suspension_acceleration: WheelData {
            rear_left: 20.734251,
            rear_right: 212.36191,
            front_left: -37.22408,
            front_right: 238.83655,
        },
        wheel_speed: WheelData {
            rear_left: 82.88415,
            rear_right: 82.90534,
            front_left: 82.5856,
            front_right: 82.60763,
        },
        wheel_slip: WheelData {
            rear_left: 0.004123952,
            rear_right: 0.0041984995,
            front_left: 0.00050301384,
            front_right: 0.000554653,
        },
        local_velocity_x: -0.116361395,
        local_velocity_y: -0.07154236,
        local_velocity_z: 82.55308,
        angular_velocity_x: -0.0026180444,
        angular_velocity_y: 0.010635535,
        angular_velocity_z: -0.011352809,
        angular_acceleration_x: -0.14016522,
        angular_acceleration_y: -0.26576725,
        angular_acceleration_z: -0.6107175,
        front_wheels_angle: 0.0,
    };

    assert_eq!(actual, expected);
}

#[test]
#[serial]
fn test_parse_2021_session_packet() {
    let stream = utils::get_stream();

    utils::send_raw_data(&stream, "e507011201012e324e2ac5eb38ad10e997421b06000013ff001d14c813110906000000f000500000ff000f000000000081aeba3d00756a0b3e00f3c5473e0041d8723e00699d8b3e00a5d2a23e00cd64c63e0086dddf3e00b77dfb3e009f55153f00fd7e263f00d8923c3f00fbd35b3f003ce06b3f000000000000000000000000000000000000000000000000000000000000000000060900001d021402020905001d02140202090a001d021402020a00001d021402040a05001d021402040a0a001d0214020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f3028fbaf3028fbaf3028fbaf000000000003010100000101");

    let p = utils::get_packet(&stream).unwrap().unwrap();

    let actual = match p {
        Packet::Session(s) => s,
        _ => panic!("Invalid packet. Expected Session, got {:?}", &p),
    };

    assert_eq!(actual.header.packet_format, 2021);

    let expected = PacketSessionData {
        header: actual.header.clone(),
        weather: Weather::Clear,
        track_temperature: 29,
        air_temperature: 20,
        total_laps: 200,
        track_length: 4371,
        session_type: SessionType::OneShotQualifying,
        track: Track::Montreal,
        formula: Formula::F1Modern,
        session_time_left: 0,
        session_duration: 240,
        pit_speed_limit: 80,
        game_paused: false,
        is_spectating: false,
        spectator_car_index: 255,
        sli_pro_native_support: false,
        num_marshal_zones: 15,
        marshal_zones: vec![
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.09115315,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.13614829,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.19509105,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.23715307,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.27268532,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.31801334,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.3874878,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.43723696,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.4911935,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.5833377,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.6503752,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.73661566,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.8587033,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.9213903,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
            MarshalZone {
                zone_start: 0.0,
                zone_flag: Flag::None,
            },
        ],
        safety_car_status: SafetyCar::None,
        network_game: false,
        num_weather_forecast_samples: 6,
        weather_forecast_samples: vec![
            WeatherForecastSample {
                session_type: SessionType::OneShotQualifying,
                time_offset: 0,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 2,
            },
            WeatherForecastSample {
                session_type: SessionType::OneShotQualifying,
                time_offset: 5,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 2,
            },
            WeatherForecastSample {
                session_type: SessionType::OneShotQualifying,
                time_offset: 10,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 2,
            },
            WeatherForecastSample {
                session_type: SessionType::Race,
                time_offset: 0,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 4,
            },
            WeatherForecastSample {
                session_type: SessionType::Race,
                time_offset: 5,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 4,
            },
            WeatherForecastSample {
                session_type: SessionType::Race,
                time_offset: 10,
                weather: Weather::Clear,
                track_temperature: 29,
                track_temperature_change: TemperatureChange::NoChange,
                air_temperature: 20,
                air_temperature_change: TemperatureChange::NoChange,
                rain_percentage: 4,
            },
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
            WeatherForecastSample::default(),
        ],
        forecast_accuracy: Some(ForecastAccuracy::Perfect),
        ai_difficulty: Some(31),
        season_identifier: Some(2952472624),
        weekend_identifier: Some(2952472624),
        session_identifier: Some(2952472624),
        pit_stop_window_ideal_lap: Some(0),
        pit_stop_window_latest_lap: Some(0),
        pit_stop_rejoin_position: Some(0),
        driving_assists: Some(DrivingAssists {
            steering_assist: false,
            braking_assist: BrakingAssist::Off,
            gearbox_assist: GearboxAssist::Automatic,
            pit_assist: true,
            pit_relase_assist: true,
            ers_assist: false,
            drs_assist: false,
            dynamic_racing_line: DynamicRacingLine::CornersOnly,
            dynamic_racing_line_type: DynamicRacingLineType::ThreeDimensions,
        }),
    };

    assert_eq!(actual, expected);
}

#[test]
#[serial]
fn test_parse_2021_event_packet() {
    let stream = utils::get_stream();

    utils::send_raw_data(
        &stream,
        "e507011201032e324e2ac5eb38ad9ba596420906000013ff50454e41102913ffff01ff00",
    );

    let p = utils::get_packet(&stream).unwrap().unwrap();

    let actual = match p {
        Packet::Event(s) => s,
        _ => panic!("Invalid packet. Expected Event, got {:?}", &p),
    };

    assert_eq!(actual.header.packet_format, 2021);

    let expected = PacketEventData {
        header: actual.header.clone(),
        event: Event::Penalty(Penalty {
            vehicle_idx: 19,
            penalty_type: PenaltyType::Retired,
            infringement_type: InfringementType::RetiredTerminallyDamaged,
            other_vehicle_idx: 255,
            time: 255,
            lap_num: 1,
            places_gained: 255,
        }),
    };

    assert_eq!(actual, expected);
}
